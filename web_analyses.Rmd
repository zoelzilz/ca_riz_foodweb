---
title: "riz_web_analyses"
output: html_document
date: "2023-02-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Goal is to analyze normal food web statistics and metrics, including (below taken from Dana's dissertation):
- # nodes
- # links
- link density
- connectance
- mean trophic level
- max trophic level
- men shortest path
- longest chain
- transitivity ??
- mean degree
- SD degree
- mean and SD generality?
- mean and SD vulnerability?
- % nodes of: top, intermediate, basal, cannibalistic, omnivorous

First we will install and load all necessary packages:
```{r packages}
#install.packages("igraph") 
#install.packages("network") 
#install.packages("sna")
#install.packages("ggraph")
#install.packages("visNetwork")
#install.packages("threejs")
#install.packages("networkD3")
#install.packages("ndtv")
#install.packages("tidyverse")
#install.packages("NetIndices")
#install.packages("cheddar")

library(igraph) 
library(network) 
library(sna)
library(ggraph)
library(visNetwork)
library(threejs)
library(networkD3)
library(ndtv) 
library(tidyverse)
library(NetIndices)
library(readxl)
library(cheddar)
```

Data + Cleaning:
```{r}

################### EDGES #################
edges_unclean <- read_csv("data/edges.csv") #manually combined lit and dissections in excel on 5 nov 22

head(edges_unclean)

links <- edges_unclean%>% 
  filter(!is.na(resourceNum)) %>% 
  filter(!is.na(consumerNum)) %>%  # we are removing rows of data that have blanks ("") or "NA" for consumer # and resource #. 
  mutate(incl.code = replace_na(incl.code, 1)) %>%  # replacing empty (NA) include codes with 1 for now so they don't get nixed as NAs, will have to manually evaluate these in excel later

  filter(incl.code != 0, 
         incl.code != 5, 
         ) # remove further interactions that we know occur outside the system (0s and 5s)


trophic_links <- links %>%   
  # need to remove non-trophic interactions!
  filter(interaction.type != 2, #epibiont
         interaction.type !=9, #endocommensal
         interaction.type !=10, #ectocommensal
         interaction.type !=22, #mutualism
         interaction.type !=28) %>%  #boring
  dplyr::select(resourceNum,consumerNum,  interaction.type) %>%  # RESOURCE NUM HAS TO GO FIRST OR WEB IS UPSIDEDOWN
  
  # and finally we need to add a column coding for parasitic interaction or nah
  mutate(parasitic = case_when(
    interaction.type > 4 & interaction.type < 8 ~ "y",
    interaction.type == 12 ~ "y",
    interaction.type > 23 & interaction.type < 26 ~ "y",
    TRUE ~ "n"
  ))

nontrophic_links <- links %>% 
    filter(interaction.type == 2, #epibiont
         interaction.type ==9, #endocommensal
         interaction.type ==10, #ectocommensal
         interaction.type ==22, #mutualism
         interaction.type ==28) %>%  #boring
  dplyr::select(resourceNum,consumerNum,  interaction.type)
  

################### NODES #################
################## CREATE NODES  #######################

# basically need to get whole list of resources and whole list of consumers and rowbind but eliminate duplicates

edges_unclean$resourceNum <- as.numeric(edges_unclean$resourceNum) #necessary to convert all the random text i wrote in instead of numbers -> NAs
edges_unclean$consumerNum <- as.numeric(edges_unclean$consumerNum) # ditto above

cnodes <- edges_unclean %>% 
  #something later in the code fucks with the select function so need dplyr::
  dplyr::select(consumerNum, consumerName, consumerStage, consumerCat) %>% 
  rename_with(~str_remove(., 'consumer')) # remove consumer from colnames, not sure of syntax

rnodes <- edges_unclean %>% 
  dplyr::select(resourceNum, resourceName, resourceStage, resourceCat) %>% 
  rename_with(~str_remove(., 'resource')) # remove resource from colnames, not sure of syntax

pre_nodes <- bind_rows(cnodes, rnodes) %>% 
  # first replace all of the NAs possible by matching them up with an existing name-num pair
  #group_by(Name) #%>%
  #mutate(Num = unique(Num[!is.na(Num)])) # i did this manually in excel, but leaving it for later in case
  
  filter(!is.na(Num)) %>%  #takes out the NAs which i put in to indicate that the node wasnt in the system
  # cant have duplicates of ID (but some dups of name bc diff life stages)
  #filter(duplicated(Name) == FALSE) %>% 
  filter(duplicated(Num) == FALSE) %>% 
  rename(id = Num)
View(pre_nodes)

################ Lets add some characteristics to the nodes for coloring the network figure #################
node_attributes <- read_excel("/Users/zoe/Library/CloudStorage/GoogleDrive-zilz@ucsb.edu/My Drive/SCHOOL/PHD_AT_UCSB/RIZ Food Web/Data/Food Web Data/DO NOT EDIT/RIZspeciesList_MASTER.xlsx", sheet = "Both") %>% 
  rename(Name = species,
         range = 'N/S/Both', 
         trophic_strategy = 'trophic strategy')

#setting up a bunch of functional groups bc this is easier
#filter feeders#
ffs <- c("tunicate", "sponge", "hydroid", "barnacle", "mussel", "bivalve", "scallop", "bryozoan", "zooplankton", "hydrocoral", "clam", "entoproct", "boring clam", "vermetid", "soft coral", "coral", "sipunculid")

#predators#
preds <- c("sea star", "asteroid", "octopus", "nudibranch", "murex", "bird", "shark", "lobster", "whelk", "sea spider", "human", "mammal", "snail")

#primary producers#
pps <- c("algae", "phytoplankton", "corraline algae", "angiosperm", "dead stuff", "dinoflagellate", "gametes")

#herbivores#
herbs <- c("urchin", "topsnail", "limpet", "littorine", "slipper snail", "true limpet", "chiton", "sea hare", "microsnail", "isopod", "abalone")

#opportunistic omnivores#
oos <- c("anemone", "shrimp", "ghost shrimp", "scale worm", "true crab", "porcelain crab", "tanaid", "copepod", "other arthropod", "cucumber", "hermit crab", "anomuran", "flatworm", "turbellarian", "polychaete", "fish", "amphipod", "microorganism", "brittle star")

#all parasites#
paras <- c("parasitic copepod", "gregarine", "parasitic barnacle", "myxozoan", "coccidian", "trematode", "cestode", "fungus", "monogene", "ciliate", "leech", "sporozoan", "orthonectid", "rhombozoan", "nematode", "nemertean")

ded <- c("dead stuff")

nodes <- left_join(pre_nodes, node_attributes) %>%  #automatically joins by name, keeping all rows in nodes while adding cols from node_attributes
  filter(duplicated(id) == FALSE) %>%  # do this again - randomly adding dups, should figure out why
  dplyr::select(id, Name, category, range, Zone, trophic_strategy) %>% 

  # now i want to fill in all the empty trophic strategies based on the category
  
  mutate(trophic_strategy2 = case_when(
    category %in% ffs ~ "filter feeder",
    category %in% preds ~ "predator",
    category %in% pps ~ "primary producer",
    category %in% herbs ~ "herbivore",
    category %in% oos ~ "opportunistic omnivores",
    category %in% paras ~ "parasites",
    category %in% ded ~ "dead stuff"
  )) %>% 
  mutate(trophic_strategy3 = coalesce(trophic_strategy, trophic_strategy2)) %>% 
  mutate(parasitic  = if_else(trophic_strategy2 == "parasites", "y", "n")) %>% 
  filter(duplicated(id) == FALSE) # do this again just in case
```


```{r indices in NetIndices}

# create matrix
net <- graph_from_data_frame(d=links, vertices=nodes, directed=T)
RIZadjmatrix <- as_adjacency_matrix(net,
                                    sparse = FALSE) # necessary to get a regular matrix


RIZindices<-GenInd(RIZadjmatrix) # takes forever to run
RIZindices

# TrophInd() takes in an adjacency matrix and gives an output of the trophic level of each node,
# as well as an index of the degree of omnivory for each node
 
trophRIZ<-TrophInd(RIZadjmatrix)
trophic_level <- trophRIZ$TL # name this vector, we should be able to add it to the nodes

mean(trophic_level)

# what percent of links are parasitic
percent_parasitic <- links %>% 
    group_by(parasitic) %>% 
    summarise( percent = 100 * n() / nrow( links ) )
```

```{r indices in cheddar}

#create matrix (community)

Community(nodes, trophic.links = links)

QuantitativeDescriptors(RIZadjmatrix)

```

