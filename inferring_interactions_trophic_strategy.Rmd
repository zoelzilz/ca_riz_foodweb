---
title: "general web cleaning"
output: html_document
date: "2024-04-17"
---
# The year is 2024 and we are approaching graduation
## The time is nigh to finish the California Rocky Intertidal Food Web
## (and we are using humor to mask the despair)

### status: all nodes and links from the Light and Smith handbook have been incorporated. We are going to try to automate some of the cleaning tasks that were previously done by hand including: 
### - full taxonomy for each node 
### - creating edges by coding instead of manual entry 
### - whatever else we can code in in less time than it takes to enter manually


###CHECKLIST: bold is what's being worked on
 ✔ pull in WORMS taxonomy for each node (done except for those that don't match an entry in WORMS)
  
 ✔ manually fix typos in original node list so that they match an existing WORMS entry, if possible, using the dataset result from the above step  
  - in doing this, realized that the dataset made from rows that don't match an entry in worms is missing all morphospecies that I PO'd...?
       ✔ OH MY GOD i had filtered out all nodes with zone = south, host range, or no data. I'm an idiot. I will need to do everything above again (as of 3/5) with the new full nodes dataset (hopefully not that bad)
       ✔ Ok this has been done twice now with all nodes and is as good as it's gonna get
        
 ✔ go through original node list (specieslistmaster) and create a forloop to make new interactions for those listed in the interaction columns
 
  ✔ **finish code to make species specific interactions dataset from literature search data **
      ✔ **don't forget to include justification code and make it match existing edgelist**
      ✔ **include consumer_num, etc)**
      
 ✔ **finish code to make TAXONOMICALLY INFERRED interactions dataset from literature search data **

 ✔ **QA/QC inferred interactions dataset** -- this ended up adding thousands of inferred interactions that were impossible to QC in a reasonable amount of time so I gave this up -- may later expand the web using genera (3/21/2024)
 
 ✔ ONGOING: cross checking node list (working) and edge list and making sure both are ready for publication
  - **specifically making sure every node at least has a trophic strategy, even if it's unknown**
  - in **this markdown** I will be seeing how many of the nodes are not represented in the current edge list
  - **will also use this markdown to code in some resources for generalist consumers**
  - can definitely do this for
    ✔ grazers
    ✔ filter feeders
    - deposit feeders
    ✔ detritivores
    ✔ scavengers
       
 • create code to incorporate GLOBI data into edgelist
  
 • last step: use Dana's code to make concomitant predation dataset
```{r setup and packages, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("igraph") 
#install.packages("network") 
#install.packages("sna")
#install.packages("ggraph")
#install.packages("visNetwork")
#install.packages("threejs")
#install.packages("networkD3")
#install.packages("ndtv")
#install.packages("tidyverse")
#install.packages("NetIndices")
#install.packages("cheddar")
#install.packages("worrms")
#install.packages("taxize")
#install.packages("googlesheets4")
#install.packages("beepr")

library(igraph) 
library(network) 
library(sna)
library(ggraph)
library(visNetwork)
library(threejs)
library(networkD3)
library(ndtv) 
library(tidyverse)
library(worrms)
library(taxize)
library(janitor)
library(googlesheets4)
library(beepr)
library(readxl)
```
 
```{r importing current edges, warning=FALSE}

# current edge list (still using xl because it's a dynamic file)
#edges <- read_xlsx("/Users/zoe/Library/CloudStorage/GoogleDrive-zilz@ucsb.edu/My Drive/SCHOOL/PHD_AT_UCSB/RIZ Food Web/Data/Food Web Data/edgelist_MASTER.xlsx")

# i've gone through this pipeline once now (4/22) so this code will yield different results since edgelist_MASTER has been edited
# going to check again and see how many species are NOW left out (round one it was like 1500)
# for reproducibility use the following dataset:
edges <- read_csv("data/edgelist_22apr2024.csv")

edges_redux <- edges %>% 
  select(consumerNum, consumerName, resourceNum, resourceName, link.ID)

edge_consumers <- edges %>% 
  select(consumerNum, consumerName) %>% 
  unite(numname, c(consumerNum, consumerName), sep = ".", remove = TRUE)

# current working node list:
nodes <- read_csv("data/RIZspecieslist_fulltaxonomy_22apr24.csv")

nodes_redux <- nodes %>% 
  select(id.x, species, life_stage, category, trophic_strategy, source, preys_on, parasitic_on, zone, habitat_notes) %>% 
  rename( consumerNum = id.x, 
          consumerName = species,
          consumerCat = category)

node_consumers <- nodes_redux %>% 
  select(consumerNum, consumerName, trophic_strategy) %>% 
  unite(numname, c(consumerNum, consumerName), sep = ".", remove = TRUE)

```
 
 
### which species in the node list are not represented in the edges list?
#### we can als figure this out by anti-joining the two lists (left join) with the more conservative list (edges) on the left
```{r anti-joining to cross check nodes with edges}

nodes_wo_edges <- anti_join(node_consumers, edge_consumers)

#just in case there were bad name/num combos, i'm going to check using just nums
# i guess the two id columns are different types so converting both to numeric:
nodes_redux$consumerNum <- as.numeric(nodes_redux$consumerNum)
edges_redux$consumerNum <- as.numeric(edges_redux$consumerNum)

nodes_wo_edges3 <- anti_join(nodes_redux, edges_redux, by = join_by(consumerNum)) # this is the dataframe we will use 

#write_csv(nodes_wo_edges2, "nodes_wo_edges_[DATE].csv") # for record keeping

```

## now we will use the above list to systematically fill in interactions based on trophic strategy
#### starting with filter feeders
```{r filter feeder inferred links}

# sort out just filter feeders
filter_feeders <- nodes_wo_edges2 %>% 
  filter(trophic_strategy == "filter feeder") %>% 
  mutate(preys_on = "filtrate")

ff_prey <- read_xlsx("/Users/zoe/Library/CloudStorage/GoogleDrive-zilz@ucsb.edu/My Drive/SCHOOL/PHD_AT_UCSB/RIZ Food Web/Data/Food Web Data/DO NOT EDIT/RIZspeciesList_MASTER.xlsx", sheet = "filter_feeder_prey") %>% 
  select(id.x, species, category) %>% 
  rename(resourceNum = id.x,
         resourceName = species,
         resourceCat = category) %>% 
  mutate(preys_on = "filtrate") # just added this on so the join will work (needs a common column)

ff_edges <- full_join(filter_feeders, ff_prey, by = join_by(preys_on)) %>% 
  # clean em up so they match the edge list and add in confidence, justifcation, etc
  mutate(consumerStage = case_when( # make the life stages match the nice clean numbers in the edge list
    life_stage == "adult" ~ 1,
    life_stage == "medusa" ~1, 
    life_stage == "hydroid colony" ~ 5,
    life_stage == "hydroid" ~ 5, 
    life_stage == "juvenile" ~ 4 # i think default should be otherwise NA which is how I want it
  )) %>% 
  mutate(resourceStage = 6) %>%  # life stage varies for all
  select(consumerNum, consumerName, consumerCat, consumerStage, resourceNum, resourceName, resourceCat, resourceStage, zone) %>% 
  # adding in all other columns necessary
  mutate(intials = "ZZ_coded", .before = consumerNum) %>% 
  mutate(interaction.type = 1,
         confidence = 4, 
         justification = 4,
         incl.code = "",
         ref_num = NA,
         .before = zone) %>% 
  mutate(pools_exposed = "pools",
         epibiota_consumed = "yes",
         notes = " ",
         link.ID = "", # i'm going to manually fill in because i'm lazy
         date_added = "17-Apr-2024")  # today's date
  
```
#### next we will do generalist grazers

```{r generalist grazer inferred links}

# lots of non-generalists in this list so going to go through and make some manual edits to the edge list first 4/17/2024

# sort out just grazers
grazers <- nodes_wo_edges2 %>% 
  filter(trophic_strategy == "grazer") %>% 
  mutate(preys_on = "primary producers")

grazer_prey <- read_xlsx("/Users/zoe/Library/CloudStorage/GoogleDrive-zilz@ucsb.edu/My Drive/SCHOOL/PHD_AT_UCSB/RIZ Food Web/Data/Food Web Data/DO NOT EDIT/RIZspeciesList_MASTER.xlsx", sheet = "grazer_prey") %>% 
  select(id.x, species, category) %>% 
  rename(resourceNum = id.x,
         resourceName = species,
         resourceCat = category) %>% 
  mutate(preys_on = "primary producers")

grazer_edges <- full_join(grazers, grazer_prey, by = join_by(preys_on)) %>% 
  # clean em up so they match the edge list and add in confidence, justifcation, etc
  mutate(consumerStage = case_when( # make the life stages match the nice clean numbers in the edge list
    life_stage == "adult" ~ 1,
    life_stage == "big" ~1, 
    life_stage == "juvenile" ~ 4 # i think default should be otherwise NA which is how I want it
  )) %>% 
  mutate(resourceStage = 1) %>%  # life stage for algae all adult, idk
  select(consumerNum, consumerName, consumerCat, consumerStage, resourceNum, resourceName, resourceCat, resourceStage, zone) %>% 
  # adding in all other columns necessary
  mutate(intials = "ZZ_coded", .before = consumerNum) %>% 
  mutate(interaction.type = 1,
         confidence = 4, 
         justification = 4,
         incl.code = "",
         ref_num = NA,
         .before = zone) %>% 
  mutate(pools_exposed = "both", # lots of conjecture here
         epibiota_consumed = "yes",
         notes = " ",
         link.ID = "", # i'm going to manually fill in because i'm lazy
         date_added = "18-Apr-2024")  # today's date
  
```


#### next detritivores and deposit feeders
```{r detritivore inferred links}

# sort out just detritivores
detritivores <- nodes_wo_edges2 %>% 
  filter(trophic_strategy == "detritivore" | trophic_strategy == "deposit feeder") %>% 
  mutate(preys_on = "dead stuff") # need to make it match

detritivore_prey <- read_xlsx("/Users/zoe/Library/CloudStorage/GoogleDrive-zilz@ucsb.edu/My Drive/SCHOOL/PHD_AT_UCSB/RIZ Food Web/Data/Food Web Data/DO NOT EDIT/RIZspeciesList_MASTER.xlsx", sheet = "scavenger_prey") %>% 
  # but we want to remove the carrion and wrack
  filter(species != "Carrion",
         species != "Wrack") %>% 
  select(id.x, species, category) %>% 
  rename(resourceNum = id.x,
         resourceName = species,
         resourceCat = category) %>% 
  mutate(preys_on = "dead stuff") # to match the other data frame

detritivore_edges <- full_join(detritivores, detritivore_prey, by = join_by(preys_on)) %>% 
  # clean em up so they match the edge list and add in confidence, justifcation, etc
  mutate(consumerStage = case_when( # make the life stages match the nice clean numbers in the edge list
    life_stage == "adult" ~ 1 # only adults in this list
    # i think default should be otherwise NA which is how I want it
  )) %>% 
  mutate(resourceStage = NA) %>%  # no life stages in dead stuff!
  select(consumerNum, consumerName, consumerCat, consumerStage, resourceNum, resourceName, resourceCat, resourceStage, zone) %>% 
  # adding in all other columns necessary
  mutate(intials = "ZZ_coded", .before = consumerNum) %>% 
  mutate(interaction.type = 1,
         confidence = 4, 
         justification = 4,
         incl.code = "",
         ref_num = NA,
         .before = zone) %>% 
  mutate(pools_exposed = "pools", # lots of conjecture here
         epibiota_consumed = "yes",
         notes = " ",
         link.ID = "", # i'm going to manually fill in because i'm lazy
         date_added = "22-Apr-2024")  # today's date
  
```


#### next scavengers
```{r scavenger inferred links}

# sort out just scavengers 
scavengers <- nodes_wo_edges2 %>% 
  filter(trophic_strategy == "scavenger") %>% 
  mutate(preys_on = "dead stuff") # need to make it match

scavenger_prey <- read_xlsx("/Users/zoe/Library/CloudStorage/GoogleDrive-zilz@ucsb.edu/My Drive/SCHOOL/PHD_AT_UCSB/RIZ Food Web/Data/Food Web Data/DO NOT EDIT/RIZspeciesList_MASTER.xlsx", sheet = "scavenger_prey") %>% 
  select(id.x, species, category) %>% 
  rename(resourceNum = id.x,
         resourceName = species,
         resourceCat = category) %>% 
  mutate(preys_on = "dead stuff") # to match the other data frame

scavenger_edges <- full_join(scavengers, scavenger_prey, by = join_by(preys_on)) %>% 
  # clean em up so they match the edge list and add in confidence, justifcation, etc
  mutate(consumerStage = case_when( # make the life stages match the nice clean numbers in the edge list
    life_stage == "adult" ~ 1 # only adults in this list
    # i think default should be otherwise NA which is how I want it
  )) %>% 
  mutate(resourceStage = NA) %>%  # no life stages in dead stuff!
  select(consumerNum, consumerName, consumerCat, consumerStage, resourceNum, resourceName, resourceCat, resourceStage, source, zone) %>% # in this one we're including source/reference
  # adding in all other columns necessary
  mutate(intials = "ZZ_coded", .before = consumerNum) %>% 
  mutate(interaction.type = 1,
         confidence = 1, # we're more confident in these
         justification = 3,
         incl.code = "",
         .before = source) %>% 
  rename(ref_num = source) %>% 
  mutate(pools_exposed = "pools", # lots of conjecture here
         epibiota_consumed = "yes",
         notes = " ",
         link.ID = "", # i'm going to manually fill in because i'm lazy
         date_added = "22-Apr-2024")  # today's date
  
```

#### next carnivores (their scavenging links only)
```{r carnivore inferred links}

# sort out just carns 
carnivores <- nodes_wo_edges2 %>% 
  filter(trophic_strategy == "carnivore (scavenger + predator)") %>% 
  mutate(preys_on = "dead stuff") # need to make it match

carnivore_prey <- read_xlsx("/Users/zoe/Library/CloudStorage/GoogleDrive-zilz@ucsb.edu/My Drive/SCHOOL/PHD_AT_UCSB/RIZ Food Web/Data/Food Web Data/DO NOT EDIT/RIZspeciesList_MASTER.xlsx", sheet = "scavenger_prey") %>% 
  filter(species == "Carrion") %>%   # meat only bish
  select(id.x, species, category) %>% 
  rename(resourceNum = id.x,
         resourceName = species,
         resourceCat = category) %>% 
  mutate(preys_on = "dead stuff") # to match the other data frame

carnivore_edges <- full_join(carnivores, carnivore_prey, by = join_by(preys_on)) %>% 
  # clean em up so they match the edge list and add in confidence, justifcation, etc
  mutate(consumerStage = case_when( # make the life stages match the nice clean numbers in the edge list
    life_stage == "adult" ~ 1 # only adults in this list
    # i think default should be otherwise NA which is how I want it
  )) %>% 
  mutate(resourceStage = NA) %>%  # no life stages in dead stuff!
  select(consumerNum, consumerName, consumerCat, consumerStage, resourceNum, resourceName, resourceCat, resourceStage, source, zone) %>% # in this one we're including source/reference
  # adding in all other columns necessary
  mutate(intials = "ZZ_coded", .before = consumerNum) %>% 
  mutate(interaction.type = 1,
         confidence = 1, # we're more confident in these
         justification = 3,
         incl.code = "",
         .before = source) %>% 
  rename(ref_num = source) %>% 
  mutate(pools_exposed = "pools", # lots of conjecture here
         epibiota_consumed = "yes",
         notes = " ",
         link.ID = "", # i'm going to manually fill in because i'm lazy
         date_added = "22-Apr-2024")  # today's date
  
```

### now we're going to add in some taxonomically based inferences (check rules spreadsheet for details):
#### like all nematodes without links get to eat the same thing
```{r free living nematode inferred links}

# sort out just nematodes 
nematodes <- nodes_wo_edges2 %>% 
  filter(consumerCat == "nematode") %>% 
  filter(trophic_strategy != "parasite") # we don't want parasite guys in there!
  # they all already prey on the same thing - microorganisms

nematode_prey <- read_xlsx("/Users/zoe/Library/CloudStorage/GoogleDrive-zilz@ucsb.edu/My Drive/SCHOOL/PHD_AT_UCSB/RIZ Food Web/Data/Food Web Data/DO NOT EDIT/RIZspeciesList_MASTER.xlsx", sheet = "small_predator_prey") %>% 
  filter(species != "Carrion") %>% 
  select(id.x, species, category) %>% 
  rename(resourceNum = id.x,
         resourceName = species,
         resourceCat = category) %>% 
  mutate(preys_on = "microorganisms") # to match the other data frame

nematode_edges <- full_join(nematodes, nematode_prey, by = join_by(preys_on)) %>% 
  # clean em up so they match the edge list and add in confidence, justifcation, etc
  mutate(consumerStage = case_when( # make the life stages match the nice clean numbers in the edge list
    life_stage == "adult" ~ 1 # only adults in this list
    # i think default should be otherwise NA which is how I want it
  )) %>% 
  mutate(resourceStage = NA) %>%  # no life stages in dead stuff!
  select(consumerNum, consumerName, consumerCat, consumerStage, resourceNum, resourceName, resourceCat, resourceStage, source, zone) %>% # in this one we're including source/reference
  # adding in all other columns necessary
  mutate(intials = "ZZ_coded", .before = consumerNum) %>% 
  mutate(interaction.type = 1,
         confidence = 1, # we're more confident in these
         justification = 3,
         incl.code = "",
         .before = source) %>% 
  rename(ref_num = source) %>% 
  mutate(pools_exposed = "both", # lots of conjecture here
         epibiota_consumed = "yes",
         notes = " ",
         link.ID = "", # i'm going to manually fill in because i'm lazy
         date_added = "22-Apr-2024")  # today's date
  
```

#### and all gammarids without links get to eat the same thing
```{r free living gammarid inferred links}

# sort out just gammarids 
gammarids <- nodes_wo_edges2 %>% 
  filter(consumerCat == "gammarid") %>% 
  filter(trophic_strategy == "omnivore") # lots of other strategies

gammarid_prey <- read_xlsx("/Users/zoe/Library/CloudStorage/GoogleDrive-zilz@ucsb.edu/My Drive/SCHOOL/PHD_AT_UCSB/RIZ Food Web/Data/Food Web Data/DO NOT EDIT/RIZspeciesList_MASTER.xlsx", sheet = "small_omnivore_prey") %>% 
  select(id.x, species, category) %>% 
  rename(resourceNum = id.x,
         resourceName = species,
         resourceCat = category) %>% 
  mutate(preys_on = "not reported") # to match the other data frame

gammarid_edges <- full_join(gammarids, gammarid_prey, by = join_by(preys_on)) %>% 
  # clean em up so they match the edge list and add in confidence, justifcation, etc
  mutate(consumerStage = case_when( # make the life stages match the nice clean numbers in the edge list
    life_stage == "adult" ~ 1 # only adults in this list
    # i think default should be otherwise NA which is how I want it
  )) %>% 
  mutate(resourceStage = case_when(resourceCat == "algae" ~ 6,
                                   resourceCat == "gametes" ~ 2,
                                   resourceCat == "microorganisms" ~ 6,
                                   resourceCat == "zooplankton" ~ 6)) %>%  
  select(consumerNum, consumerName, consumerCat, consumerStage, resourceNum, resourceName, resourceCat, resourceStage, source, zone) %>% # in this one we're including source/reference
  # adding in all other columns necessary
  mutate(intials = "ZZ_coded", .before = consumerNum) %>% 
  mutate(interaction.type = case_when(resourceCat == "dead stuff" ~ 30, #scavenging
                                     resourceCat == "algae" ~ 3, #grazing
                                     .default = 1)) %>%  #normal predation
  mutate(
         confidence = 1, # we're more confident in these
         justification = 3,
         incl.code = "",
         .before = source) %>% 
  rename(ref_num = source) %>% 
  mutate(pools_exposed = "both", # lots of conjecture here
         epibiota_consumed = "yes",
         notes = " ",
         link.ID = "", # i'm going to manually fill in because i'm lazy
         date_added = "22-Apr-2024")  # today's date
  
```

## now we can put all these new links together into a csv and copy them into edgelist master
```{r rbind new links together}

new_inferred_links_22apr2024 <- rbind(ff_edges, grazer_edges, scavenger_edges, detritivore_edges, nematode_edges, gammarid_edges, carnivore_edges)

write_csv(new_inferred_links_22apr2024, "new_inferred_links_22apr2024_2.csv")

```

## lets check on how many nodes have missing edges now (it should only be the typical predators, some parasites, and primary producers)

```{r checking our work, warning=FALSE}

# current edge list (still using xl because it's a dynamic file)
edges_check <- read_xlsx("/Users/zoe/Library/CloudStorage/GoogleDrive-zilz@ucsb.edu/My Drive/SCHOOL/PHD_AT_UCSB/RIZ Food Web/Data/Food Web Data/edgelist_MASTER.xlsx")

edges_redux_check <- edges_check %>% 
  select(consumerNum, consumerName, resourceNum, resourceName, link.ID)

# current working node list:
nodes_check <- read_csv("data/RIZspecieslist_fulltaxonomy_22apr24.csv")

nodes_redux_check <- nodes_check %>% 
  select(id.x, species, life_stage, category, trophic_strategy, source, preys_on, parasitic_on, zone, habitat_notes) %>% 
  rename( consumerNum = id.x, 
          consumerName = species,
          consumerCat = category)

nodes_redux_check$consumerNum <- as.numeric(nodes_redux_check$consumerNum)
edges_redux_check$consumerNum <- as.numeric(edges_redux_check$consumerNum)

nodes_wo_edges_check <- anti_join(nodes_redux_check, edges_redux_check, by = join_by(consumerNum)) # this is the dataframe we will use 

#write_csv(nodes_wo_edges2, "nodes_wo_edges_[DATE].csv") # for record keeping

```

