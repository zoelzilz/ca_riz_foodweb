---
title: "Final Foodweb Analyses"
output: html_notebook
---
# Analysis of the California Rocky Intertidal Zone Food Web
```{r setup and packages}
#install.packages("igraph") 
#install.packages("network") 
#install.packages("sna")
#install.packages("ggraph")
#install.packages("visNetwork")
#install.packages("threejs")
#install.packages("networkD3")
#install.packages("ndtv")
#install.packages("tidyverse")
#install.packages("NetIndices")
#install.packages("cheddar")
#install.packages("grDevices")

library(igraph) 
library(network) 
library(sna)
library(ggraph)
library(visNetwork)
library(threejs)
library(networkD3)
library(ndtv) 
library(tidyverse)
library(viridis)
library(cheddar)

```

## Part One: Summary Statistics and Graphs
 
### Reading in the cleaned versions of the data from May 2024
(we created and saved these csvs in the final_foodweb_build RMD)
```{r read in clean data}

nodes <- read_csv("data/foodweb_V4/nodes_final_3jun2024.csv") %>% 
  mutate(zone = case_when(
    zone == "low tidepools" ~ "low",
    zone == "low to very low" ~ "low",
    zone == "middle and low" ~ "middle", 
    zone == "middle to low" ~ "middle",
    zone == "middle, low" ~ "middle",
    zone == "high and middle" ~ "high",
    zone == "mid to low" ~ "middle",
    zone == "high tide pools, nocturnal" ~ "high",
    zone == "high, middle" ~ "high",
    zone == "high to middle" ~ "high",
    zone == "low to high" ~ "all",
    zone == "pools" ~ "all",
    zone == "tidepools" ~ "all",
    zone == "host range" ~ "all",
    zone == "varies" ~ "all",
    zone == "unknown" ~ "no data",
    is.na(zone) ~ "all", # this is a bit of a stretch but we need to not have NAs
    .default = as.character(zone))) %>% 
  mutate(parasite = case_when(str_detect(trophic_strategy, "parasit") ~ "y",
                              trophic_strategy == "pathogen" ~ "y",
                              .default = "n"))

view(nodes)

all_links <- read_csv("data/foodweb_V4/links_final_3jun2024.csv")

# calling the links list "links" but it's ONLY trophic links
#also switched from using the uncollapsed link list (~15k links) to the [final] list with no duplicates (~14k links)

links <- all_links %>% 
  
  # need to remove non-trophic interactions!
  filter(interaction.type != 2, #epibiont
         interaction.type !=9, #endocommensal
         interaction.type !=10, #ectocommensal
         interaction.type !=22, #mutualism
         #interaction.type !=28, #boring # i think we need to leave boring in because of the gammarids that bore and eat
         interaction.type != 29) %>%  
  
  # and finally we need to add a column coding for parasitic interaction or nah
  mutate(parasitic = case_when(
    interaction.type > 4 & interaction.type < 8 ~ "y",
    interaction.type == 12 ~ "y",
    interaction.type > 23 & interaction.type < 27 ~ "y", # we're calling sessile micropredation parasitic here
    TRUE ~ "n"
  ))

write_csv(links, "data/foodweb_V4/trophic_links.csv")

```


### Just some fun summary stuff
```{r summary}

# how many unique species?
n_distinct(nodes$species)

# how many nodes (including life stages)
n_distinct(nodes$nodeNum)

# how many species above PC
north_nodes <- nodes %>% 
  filter(province != "S")

n_distinct(north_nodes$species)

# and below

south_nodes <- nodes %>% 
  filter(province != "N") 

n_distinct(south_nodes$species)

# and both

both_nodes <- nodes %>% 
  filter(province == "Both" | province == "Central")

n_distinct(both_nodes$species)

```


### Some stacked barcharts, for fun!

```{r stacked barcharts - trophic groups}

# comparison of functional groups north and south of PC
south_func_groups <- south_nodes %>% 
  filter(!is.na(trophic_strategy)) %>% 
  group_by(trophic_strategy) %>% 
  summarise(count = n()) %>%  # count of nodes in each trophic group
  mutate(n_s = "south") # add a column notating these are south so I can combine tibbles later


north_func_groups <- north_nodes %>% 
  filter(!is.na(trophic_strategy)) %>% 
  group_by(trophic_strategy) %>% 
  summarise(count = n()) %>% 
  mutate(n_s = "north")

func_groups <- rbind(north_func_groups, south_func_groups) %>% 
  mutate(trophic_strategy = fct_relevel(as.factor(trophic_strategy), c("non-feeding", "various (assemblage)", "primary producer", "mixotroph", "grazer", "filter feeder", "micropredator",   "detritivore","deposit feeder", "scavenger", "omnivore", "carnivore (scavenger + predator)", "symbiotic egg predator","typical predator","parasite", "parasitic castrator", "unknown"))) %>%  # reordering these so they make logical sense in the graph
  arrange(trophic_strategy) # for good measure


#assign some colors

colors = c("lightgrey", # non feeding
           "grey", # assemblage
           "limegreen", # primary producer
           "lightgreen", # mixotroph
           "darkgreen", #grazer
           "blue", #filter feeder
           "purple", # micropredator
           "tan", #detritivore
           "tan2", # deposit feeder
           "tan3", # scavenger
           "orange", #omnivore
           "pink", #carnivore
           "red", #egg pred
           "darkred", # typical pred
           "gold", #parasite
           "yellow", #castrator
           "black" #unknown
)

# trophic function plot                          
func_barplot <- ggplot(func_groups, aes(fill = trophic_strategy, x = n_s, y = count)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(values = colors) +
  theme_classic()

func_barplot               

```

```{r stacked barcharts - zones}

# comparison of zone fidelity north and south of PC
## using color palette grDevices::BrBG

south_zone_groups <- south_nodes %>% 
  filter(!is.na(zone)) %>% 
  group_by(zone) %>% 
  summarise(count = n()) %>%  # count of nodes in each trophic group
  mutate(n_s = "south") # add a column notating these are south so I can combine tibbles later


north_zone_groups <- north_nodes %>% 
  filter(!is.na(zone)) %>% 
  group_by(zone) %>% 
  summarise(count = n()) %>% 
  mutate(n_s = "north")

# put together and reorder zone for plotting
zone_groups <- rbind(north_zone_groups, south_zone_groups) %>% 
  mutate(zone = fct_relevel(zone, c("all", "high",  "middle",  "low", "very low", "no data")))

zone_barplot <- ggplot(zone_groups, aes(fill = zone, x = n_s, y = count)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_brewer(palette = "BrBG")+
  theme_classic()

zone_barplot

```



## Switching to cheddar for the analyses
#### Our csvs have to be a little different now:
https://cran.r-project.org/web/packages/cheddar/vignettes/ImportExport.pdf
### OR we can manipulate our existing dataframes to fit cheddar's standards (more reproducible but cheddar hates this and makes it hard)
```{r create cheddar data}
# adjust dataframes a littel for cheddar (node column needs to be called node, links column needs to have consumer and resource columns, need a properties dataframe?)

cheddar_nodes <- nodes %>% # ugh i hate this but i don't have a choice
  # make a new column that concatenates node name, num, and life stage bc cheddar can't handle numeric node names
  unite(node, c(nodeNum, species, clean_stage), sep = "_", remove = FALSE)

trophic.links <- links %>% 
  # make a new column that concatenates node name, num, and life stage bc cheddar can't handle numeric node names
  unite(resource, c(resourceNum, resourceName, resourceStage), sep = "_", remove = FALSE) %>% 
  unite(consumer, c(consumerNum, consumerName, consumerStage), sep = "_", remove = FALSE) %>% 
  rename(link_zone = zone, 
         link_notes = notes) %>% 
  # cheddar can't handle duplicates so we need to get rid of them
  distinct(consumer, resource, .keep_all = TRUE)

# create properties list
properties <- list(title = "ca riz total") #syntax that the help doc suggests

# create community object
ca_riz_total <- Community(cheddar_nodes, properties, trophic.links = trophic.links)
ca_riz_total

```

### Actual analysis time!
### some non-network metrics that food web papers usually report:
https://cran.r-project.org/web/packages/cheddar/vignettes/Community.pdf
```{r summary metrics}

# top predators (incoming non-parasite links only)
FractionNonTopLevelNodes(ca_riz_total)

# intermediate consumers
FractionIntermediateNodes(ca_riz_total)

# primary producers or basal links
FractionBasalNodes(ca_riz_total)

# isolated nodes
FractionIsolatedNodes(ca_riz_total)
IsolatedNodes(ca_riz_total)

# parasite nodes
pnodes <- nodes %>% 
  filter(parasite == "y") %>% 
  count()
pnodes

#parasite species
sp_pnodes <- nodes %>% 
  filter(parasite == "y") %>% 
  distinct(species) %>% 
  count()
sp_pnodes

# all species
spnodes <- nodes %>% 
  distinct(species) %>% 
  count()
spnodes

# free living nodes

fnodes <- nodes %>% 
  filter(parasite == "n") %>% 
  count()
fnodes

# free living species

sp_fnodes <- nodes %>% 
  filter(parasite == "n") %>% 
  distinct(species) %>% 
  count()
sp_fnodes

# parasitic links
plinks <- links %>% 
  filter(parasitic == "y") %>% 
  count()
plinks

# omnivory (taxa feeding on multiple trophic levels)

# cannibalism

#TrophicChains(ca_riz_total) # web is too big for this
#chain.stats <- TrophicChainsStats(ca_riz_total) # web is also too big for this

```

